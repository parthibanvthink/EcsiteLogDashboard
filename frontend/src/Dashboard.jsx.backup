import { useState } from "react"
import { Header } from "./Header"
import { FileUpload } from "./FileUpload"
import { LogFilesList } from "./LogFilesList"
import { AnalysisLoading } from "./AnalysisLoading"
import { LogInsights } from "./LogInsights"
import axios from "axios"

const API_BASE = "http://127.0.0.1:8000"

export default function Dashboard() {
  const [currentView, setCurrentView] = useState("upload")
  const [logFiles, setLogFiles] = useState([])
  const [logsData, setLogsData] = useState([])
  const [isProcessing, setIsProcessing] = useState(false)

  const handleFileUpload = async (files) => {
    const newFiles = files.map((file) => ({
      id: Math.random().toString(36).substr(2, 9),
      name: file.name,
      progress: 0,
      status: "processing",
      canCancel: true,
    }))

    setLogFiles((prev) => [...prev, ...newFiles])
    setIsProcessing(true)

    // Process each file with the backend
    for (const file of files) {
      await processFileWithBackend(file, newFiles.find(f => f.name === file.name)?.id)
    }
  }

  const processFileWithBackend = async (file, fileId) => {
    const formData = new FormData()
    formData.append("file", file)

    try {
      // Update progress
      setLogFiles((prev) => prev.map((f) => (f.id === fileId ? { ...f, progress: 50 } : f)))

      // Upload file to backend
      const response = await axios.post(`${API_BASE}/read-log/`, formData, {
        headers: { "Content-Type": "multipart/form-data" },
      })

      // Update progress to 100% and mark as completed
      setLogFiles((prev) =>
        prev.map((f) =>
          f.id === fileId
            ? { ...f, progress: 100, status: "completed", canCancel: false }
            : f,
        ),
      )

      console.log("File processed successfully:", response.data)
    } catch (error) {
      console.error("Error processing file:", error)
      // Mark file as failed
      setLogFiles((prev) =>
        prev.map((f) =>
          f.id === fileId
            ? { ...f, progress: 100, status: "failed", canCancel: false }
            : f,
        ),
      )
    }
  }

  const handleStartAnalysis = async () => {
    setCurrentView("loading")
    setIsProcessing(true)

    try {
      // Fetch logs from backend
      const response = await axios.get(`${API_BASE}/logs`)
      setLogsData(response.data.logs || [])
      
      // Simulate analysis delay
      setTimeout(() => {
        setCurrentView("insights")
        setIsProcessing(false)
      }, 3000)
    } catch (error) {
      console.error("Error fetching logs:", error)
      setIsProcessing(false)
      // You might want to show an error message to the user
    }
  }

  const handleGoBack = () => {
    setCurrentView("upload")
    setLogsData([])
  }

  const handleRemoveFile = (fileId) => {
    setLogFiles((prev) => prev.filter((file) => file.id !== fileId))
  }

  const handleCancelFile = (fileId) => {
    setLogFiles((prev) =>
      prev.map((file) => (file.id === fileId ? { ...file, status: "failed", canCancel: false } : file)),
    )
  }

  return (
    <div className="min-h-screen w-full bg-[#F4F8FB]">
      <Header />

      <main className="w-full px-[48px] py-8">
        {currentView === "upload" && (
          <>
            <FileUpload onFileUpload={handleFileUpload} />
            <LogFilesList
              files={logFiles}
              onStartAnalysis={handleStartAnalysis}
              onRemoveFile={handleRemoveFile}
              onCancelFile={handleCancelFile}
            />
          </>
        )}

        {currentView === "loading" && <AnalysisLoading />}

        {currentView === "insights" && <LogInsights onGoBack={handleGoBack} logsData={logsData} />}
      </main>
    </div>
  )
}
